<!DOCTYPE html>
<html>
<head>
    <title>Cagong Chat with Map</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=837372e8e2d4e19bc68abe6ed1948d95&libraries=services"></script>

    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .view { display: none; } /* 모든 뷰는 일단 숨김 */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
        #chatroom-list { list-style: none; padding: 0; }
        #chatroom-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #chatroom-list li:hover { background-color: #f0f0f0; }
        #map { width: 100%; height: 400px; margin-bottom: 15px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">

    <div id="login-view" class="view" style="display: block;">
        <h2>로그인</h2>
        <div class="form-group"><input type="text" id="login-email" placeholder="이메일 또는 사용자명"></div>
        <div class="form-group"><input type="password" id="login-password" placeholder="비밀번호"></div>
        <button onclick="login()">로그인</button>
        <button onclick="showSignupView()">회원가입</button>
    </div>

    <div id="signup-view" class="view">
        <h2>회원가입</h2>
        <div class="form-group">
            <label for="signup-username">사용자명</label>
            <input type="text" id="signup-username" placeholder="Username">
        </div>
        <div class="form-group">
            <label for="signup-email">이메일</label>
            <input type="text" id="signup-email" placeholder="Email">
        </div>
        <div class="form-group">
            <label for="signup-password">비밀번호</label>
            <input type="password" id="signup-password" placeholder="Password">
        </div>
        <button onclick="signup()">가입하기</button>
        <button onclick="showView('login-view')">로그인으로 돌아가기</button>
    </div>

    <div id="map-view" class="view">
        <h2>주변 카페 선택</h2>
        <div id="map"></div>
        <button onclick="logout()">로그아웃</button>
    </div>

    <div id="chatroom-list-view" class="view">
        <h2 id="selected-cafe-name"></h2>
        <p>참여할 채팅방을 선택하거나, 새 채팅방을 만들어보세요.</p>
        <ul id="chatroom-list"></ul>
        <button onclick="showCreateRoomForm()" id="create-room-btn">새 채팅방 만들기</button>
        <button onclick="backToMap()">지도으로 돌아가기</button>
    </div>

    <div id="create-chatroom-view" class="view">
        <h3 id="create-room-cafe-name"></h3>
        <div class="form-group"><input type="text" id="room-title" placeholder="채팅방 제목"></div>
        <button onclick="createChatRoom()">만들기</button>
        <button onclick="backToChatRoomList()">취소</button>
    </div>

    <div id="chat-view" class="view">
        <h2 id="chat-room-title"></h2>
        <div id="messages"></div>
        <div class="form-group" style="display: flex;">
            <input type="text" id="message-input" placeholder="메시지를 입력하세요...">
            <button onclick="sendMessage()">전송</button>
        </div>
        <button onclick="disconnect()">채팅방 나가기</button>
    </div>

</div>

<script>
    // 전역 변수
    let jwtToken = null;
    let stompClient = null;
    let currentCafe = null;
    let currentRoomId = null;
    let map = null;

    // 뷰 전환 헬퍼
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
    }

    // 회원가입 뷰를 보여주는 함수
    function showSignupView() {
        showView('signup-view');
    }

    // 0. 회원가입 기능
    async function signup() {
        const username = document.getElementById('signup-username').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;

        if (!username || !email || !password) {
            alert('모든 항목을 입력해주세요.');
            return;
        }

        try {
            const response = await fetch('/members/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });

            // 서버에서 오는 에러 메시지를 받기 위한 처리
            if (!response.ok) {
                // 서버에서 JSON 형태의 에러 메시지를 보낸다면 아래와 같이 처리 가능
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || '회원가입에 실패했습니다. (아이디/이메일 중복 등)');
            }

            const data = await response.json();
            alert(data.message || '회원가입 성공! 이제 로그인 해주세요.');
            showView('login-view'); // 성공 시 로그인 뷰로 전환

        } catch (error) {
            alert(error.message);
        }
    }

    // 1. 로그인
    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const response = await fetch('/members/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usernameOrEmail: email, password: password })
            });
            if (!response.ok) throw new Error('로그인 실패');
            const data = await response.json();
            jwtToken = data.accessToken;
            alert('로그인 성공!');
            showView('map-view');
            loadMap(); // 로그인 성공 후 지도 로드
        } catch (error) { alert(error.message); }
    }

    function logout() {
        jwtToken = null;
        alert('로그아웃 되었습니다.');
        showView('login-view');
    }

    // 2. 지도 로드 및 카페 검색
    function loadMap() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(37.4979, 127.0276), // 강남역 중심
            level: 3
        };
        map = new kakao.maps.Map(mapContainer, mapOption);

        const ps = new kakao.maps.services.Places();
        ps.keywordSearch('카페', (data, status, pagination) => {
            if (status === kakao.maps.services.Status.OK) {
                data.forEach(place => {
                    const marker = new kakao.maps.Marker({
                        map: map,
                        position: new kakao.maps.LatLng(place.y, place.x)
                    });

                    // 마커에 클릭 이벤트를 등록합니다
                    kakao.maps.event.addListener(marker, 'click', () => {
                        selectCafe(place.place_name);
                    });
                });
            }
        }, { location: map.getCenter() });
    }

    async function selectCafe(cafeName) {
        try {
            const response = await fetch(`/api/cafes/details?query=${encodeURIComponent(cafeName)}`);
            if (!response.ok) throw new Error('카페 정보를 불러오는 데 실패했습니다.');
            const data = await response.json();
            currentCafe = data;

            document.getElementById('selected-cafe-name').innerText = data.name;
            const listElement = document.getElementById('chatroom-list');
            listElement.innerHTML = '';
            if (data.chatRooms.length === 0) {
                listElement.innerHTML = '<li>개설된 채팅방이 없습니다.</li>';
            } else {
                data.chatRooms.forEach(room => {
                    const li = document.createElement('li');
                    li.innerText = `${room.title} (ID: ${room.id})`;
                    li.onclick = () => joinChatRoom(room.id, room.title);
                    listElement.appendChild(li);
                });
            }
            showView('chatroom-list-view');
        } catch (error) { alert(error.message); }
    }

    function backToMap() {
        showView('map-view');
    }

    // 3. 채팅방 생성/목록 뷰 관련
    function showCreateRoomForm() {
        document.getElementById('create-room-cafe-name').innerText = `${currentCafe.name}에 새 채팅방 만들기`;
        showView('create-chatroom-view');
    }

    function backToChatRoomList() {
        showView('chatroom-list-view');
    }

    async function createChatRoom() {
        const title = document.getElementById('room-title').value;
        if (!title) { alert('채팅방 제목을 입력해주세요.'); return; }
        try {
            const response = await fetch('/api/chat-rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ title: title, cafeId: currentCafe.cafeId, maxParticipants: 10 })
            });
            if (!response.ok) throw new Error('채팅방 생성 실패');
            const newRoom = await response.json();
            alert(`'${newRoom.title}' 채팅방이 생성되었습니다!`);
            joinChatRoom(newRoom.id, newRoom.title);
        } catch (error) { alert(error.message); }
    }

    // 4. 채팅방 참여 (웹소켓)
    function joinChatRoom(roomId, roomTitle) {
        if (!jwtToken) { alert('로그인이 필요합니다.'); return; }
        currentRoomId = roomId;
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        const headers = { 'Authorization': `Bearer ${jwtToken}` };
        stompClient.connect(headers, (frame) => {
            console.log('Connected: ' + frame);
            showView('chat-view');
            document.getElementById('chat-room-title').innerText = roomTitle;
            stompClient.subscribe(`/sub/chat/room/${roomId}`, (message) => showMessage(JSON.parse(message.body)));
            stompClient.send("/pub/chat/message", {}, JSON.stringify({ type: 'ENTER', roomId: roomId }));
        }, (error) => alert("연결 실패:\n" + error));
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(() => {
                alert("채팅방에서 나왔습니다.");
                // 채팅방 목록 뷰로 돌아가기 전에, 해당 카페 정보를 다시 불러옵니다.
                selectCafe(currentCafe.name);
            });
        }
        stompClient = null;
    }

    function sendMessage() {
        const messageContent = document.getElementById('message-input').value;
        if (messageContent && stompClient) {
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                type: 'TALK',
                roomId: currentRoomId,
                message: messageContent
            }));
            document.getElementById('message-input').value = '';
        }
    }

    function showMessage(message) {
        const messages = document.getElementById('messages');
        const messageElement = document.createElement('p');
        let content = `[${message.sender}] ${message.message}`;
        if (message.type === 'ENTER' || message.type === 'QUIT') {
            content = `--- ${message.message} ---`;
        }
        messageElement.appendChild(document.createTextNode(content));
        messages.appendChild(messageElement);
        messages.scrollTop = messages.scrollHeight;
    }
</script>

</body>
</html>